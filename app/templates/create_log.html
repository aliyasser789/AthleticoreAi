<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Workout Log - Athleticore</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="dashboard-body">
   <nav class="top-nav">
        <div class="logo">ATHLETICORE<span class="ai-text">.AI</span></div>
        
        <ul class="nav-links">
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/tdee">TDEE</a></li>
            <li><a href="/calories">Calories</a></li>
            <li><a href="/workout" class="active">Workout</a></li>
            <li><a href="#">Coach</a></li>
            <li><a href="#">Settings</a></li>
        </ul>
   </nav>
   <main class="main-content">
        <h2 class="section-title">Create Workout Log</h2>
        
        <div class="create-log-container">
            <form id="workout-log-form">
                <!-- Form Header -->
                <div class="form-header">
                    <div class="form-group">
                        <label for="log-name" class="form-label">Log Name</label>
                        <input type="text" id="log-name" name="log-name" class="form-input large-input" placeholder="e.g., Chest Day" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="day-of-week" class="form-label">Day of Week</label>
                        <select id="day-of-week" name="day-of-week" class="form-input" required>
                            <option value="">Select Day</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                    </div>
                </div>

                <!-- Exercise Entry Container -->
                <div class="exercises-section">
                    <h3 class="section-subtitle">Exercises</h3>
                    <div id="exercises-list">
                        <!-- First exercise entry -->
                        <div class="exercise-entry">
                            <button type="button" class="remove-exercise" onclick="removeExercise(this)">×</button>
                            <div class="form-group">
                                <label class="form-label">Exercise Name</label>
                                <input type="text" class="form-input" name="exercise-name" placeholder="e.g., Bench Press" required>
                            </div>
                            
                            <div class="inline-inputs">
                                <div class="input-group">
                                    <label class="form-label">Weight (kg)</label>
                                    <input type="number" class="form-input small-input" name="weight" placeholder="0" min="0" step="0.5">
                                </div>
                                <div class="input-group">
                                    <label class="form-label">Prev Weight (kg)</label>
                                    <input type="number" class="form-input small-input" name="prev-weight" placeholder="0" min="0" step="0.5">
                                </div>
                                <div class="input-group">
                                    <label class="form-label">Reps</label>
                                    <input type="number" class="form-input small-input" name="reps" placeholder="0" min="0">
                                </div>
                                <div class="input-group">
                                    <label class="form-label">Sets</label>
                                    <input type="number" class="form-input small-input" name="sets" placeholder="0" min="0">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea class="form-input form-textarea" name="notes" placeholder="Add any notes about this exercise..." rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add Exercise Button -->
                    <button type="button" class="add-exercise-btn" onclick="addExerciseField()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>

                <!-- Save Button -->
                <button type="submit" class="save-log-btn">Save Log</button>
            </form>
        </div>
   </main>
   
   <!-- Toast Notification Container -->
   <div class="toast-container" id="toast-container"></div>
   
   <script>
        // Toast notification function
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '✓' : '✕';
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
   </script>
   <script>
        // Function to remove an exercise field
        function removeExercise(btn) {
            const exerciseEntry = btn.closest('.exercise-entry');
            if (exerciseEntry) {
                exerciseEntry.remove();
            }
        }

        // Function to add a new exercise field
        function addExerciseField() {
            const exercisesList = document.getElementById('exercises-list');
            const newExercise = document.createElement('div');
            newExercise.className = 'exercise-entry';
            
            newExercise.innerHTML = `
                <button type="button" class="remove-exercise" onclick="removeExercise(this)">×</button>
                <div class="form-group">
                    <label class="form-label">Exercise Name</label>
                    <input type="text" class="form-input" name="exercise-name" placeholder="e.g., Bench Press" required>
                </div>
                
                <div class="inline-inputs">
                    <div class="input-group">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" class="form-input small-input" name="weight" placeholder="0" min="0" step="0.5">
                    </div>
                    <div class="input-group">
                        <label class="form-label">Prev Weight (kg)</label>
                        <input type="number" class="form-input small-input" name="prev-weight" placeholder="0" min="0" step="0.5">
                    </div>
                    <div class="input-group">
                        <label class="form-label">Reps</label>
                        <input type="number" class="form-input small-input" name="reps" placeholder="0" min="0">
                    </div>
                    <div class="input-group">
                        <label class="form-label">Sets</label>
                        <input type="number" class="form-input small-input" name="sets" placeholder="0" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input form-textarea" name="notes" placeholder="Add any notes about this exercise..." rows="3"></textarea>
                </div>
            `;
            
            exercisesList.appendChild(newExercise);
        }

        // Helper function to convert day of week to ISO date
        function getDateForDayOfWeek(dayOfWeek) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const today = new Date();
            const currentDay = today.getDay();
            const targetDay = days.indexOf(dayOfWeek);
            
            // Calculate days difference
            let daysDiff = targetDay - currentDay;
            if (daysDiff < 0) {
                daysDiff += 7; // If target day has passed this week, use next week
            }
            
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() + daysDiff);
            
            // Return ISO date string (YYYY-MM-DD)
            return targetDate.toISOString().split('T')[0];
        }

        // Handle form submission
        document.getElementById('workout-log-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get user from localStorage
            const storedUser = localStorage.getItem('athleticore_user');
            if (!storedUser) {
                showToast('Please log in first', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }
            
            let user;
            try {
                user = JSON.parse(storedUser);
            } catch (err) {
                console.error('Failed to parse stored user', err);
                showToast('Session expired. Please log in again.', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }
            
            if (!user || !user.id) {
                showToast('User information not found. Please log in again.', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }
            
            // Get form data
            const workoutName = document.getElementById('log-name').value.trim();
            const dayOfWeek = document.getElementById('day-of-week').value;
            
            if (!workoutName || !dayOfWeek) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            // Convert day of week to ISO date
            const logDate = getDateForDayOfWeek(dayOfWeek);
            
            // Collect all exercises
            const exerciseEntries = document.querySelectorAll('.exercise-entry');
            const exercises = [];
            
            exerciseEntries.forEach((entry, index) => {
                const exerciseName = entry.querySelector('input[name="exercise-name"]').value.trim();
                const weight = entry.querySelector('input[name="weight"]').value;
                const prevWeight = entry.querySelector('input[name="prev-weight"]').value;
                const reps = entry.querySelector('input[name="reps"]').value;
                const sets = entry.querySelector('input[name="sets"]').value;
                const notes = entry.querySelector('textarea[name="notes"]').value.trim();
                
                if (exerciseName) { // Only add if exercise name is provided
                    // Parse sets and reps - they are required
                    const setsStr = sets ? sets.trim() : '';
                    const repsStr = reps ? reps.trim() : '';
                    const setsValue = setsStr ? parseInt(setsStr) : null;
                    const repsValue = repsStr ? parseInt(repsStr) : null;
                    
                    // Validate required fields
                    if (!setsStr || setsValue === null || isNaN(setsValue) || setsValue <= 0) {
                        showToast(`Exercise "${exerciseName}": Sets is required and must be greater than 0`, 'error');
                        return;
                    }
                    
                    if (!repsStr || repsValue === null || isNaN(repsValue) || repsValue <= 0) {
                        showToast(`Exercise "${exerciseName}": Reps is required and must be greater than 0`, 'error');
                        return;
                    }
                    
                    exercises.push({
                        exercise_name: exerciseName, // API expects exercise_name
                        weight_kg: weight && weight.trim() ? parseFloat(weight) : 0.0,
                        previous_weight: prevWeight && prevWeight.trim() ? parseFloat(prevWeight) : 0.0, // API expects previous_weight
                        reps: repsValue,
                        sets: setsValue,
                        order_index: index, // Add order_index
                        notes: notes || null
                    });
                }
            });
            
            if (exercises.length === 0) {
                showToast('Please add at least one exercise', 'error');
                return;
            }
            
            // Build final JSON object matching API expectations
            const workoutData = {
                user_id: user.id,
                workout_name: workoutName, // API expects workout_name
                log_date: logDate, // API expects log_date (ISO format)
                notes: null, // Optional, can be added later if needed
                exercises: exercises
            };
            
            // Debug: Log the data being sent
            console.log('Sending workout data:', JSON.stringify(workoutData, null, 2));
            
            // Send to backend API
            try {
                const response = await fetch('/api/workouts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(workoutData)
                });
                
                let data;
                try {
                    data = await response.json();
                } catch (parseError) {
                    console.error('Failed to parse response:', parseError);
                    const text = await response.text();
                    console.error('Response text:', text);
                    alert('Error: Server returned invalid response. Status: ' + response.status);
                    return;
                }
                
                console.log('API Response:', data);
                
                if (!response.ok) {
                    // Show the actual error message from the server
                    const errorMsg = data.error || 'Failed to create workout';
                    console.error('API Error:', errorMsg, 'Status:', response.status);
                    
                    // Show a more user-friendly error message
                    let userMessage = errorMsg;
                    if (errorMsg.includes('no such table')) {
                        userMessage = 'Database not initialized. Please contact support.';
                    } else if (errorMsg.includes('Database error')) {
                        userMessage = 'Database error occurred. Please try again.';
                    }
                    
                    showToast(userMessage, 'error');
                    return;
                }
                
                // Success - show toast and redirect to workout page
                showToast('Workout log created successfully!', 'success');
                setTimeout(() => {
                    window.location.href = '/workout';
                }, 1500);
            } catch (error) {
                console.error('Error creating workout:', error);
                showToast(error.message || 'Failed to create workout. Please try again.', 'error');
            }
        });
   </script>
</body>
</html>

