<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athleticore Login</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="dashboard-body">
   <nav class="top-nav">
        <div class="logo">ATHLETICORE<span class="ai-text">.AI</span></div>
        
        <ul class="nav-links">
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/tdee" class="active">TDEE</a></li>
            <li><a href="#">Calories</a></li>
            <li><a href="#">Workout</a></li>
            <li><a href="#">Coach</a></li>
            <li><a href="#">Settings</a></li>
        </ul>
   </nav>
   <main class="main-content">
    <div class="chat-section"> 
        <h1>AI Coach</h1>
        <div class="chat-window">
           
        </div>
        <div class="chat-input-area">
                <input type="text" placeholder="Type a message..." class="chat-input" autocomplete="off">
                <button type="button" class="send-btn">SEND</button>
            </div>

        <section class="chat-form-section">
            <h2 class="section-title">AI Summary</h2>
            <div class="stats-grid summary-grid">
                <div class="summary-item">
                    <label>Gender</label>
                    <span id="summary-gender">--</span>
                </div>
                <div class="summary-item">
                    <label>Age</label>
                    <span id="summary-age">--</span>
                </div>
                <div class="summary-item">
                    <label>Height (cm)</label>
                    <span id="summary-height">--</span>
                </div>
                <div class="summary-item">
                    <label>Weight (kg)</label>
                    <span id="summary-weight">--</span>
                </div>
                <div class="summary-item">
                    <label>Activity Level</label>
                    <span id="summary-activity">--</span>
                </div>
                <div class="summary-item">
                    <label>Goal Type</label>
                    <span id="summary-goal-type">--</span>
                </div>
                <div class="summary-item">
                    <label>Goal Offset</label>
                    <span id="summary-goal-offset">--</span>
                </div>
                <div class="summary-item highlight">
                    <label style="color:#00A8FF;">TDEE Value</label>
                    <span id="summary-tdee">Waiting for AI...</span>
                </div>
                <div class="summary-item highlight">
                    <label style="color:#00A8FF;">Goal Calories</label>
                    <span id="summary-goal-calories">Waiting for AI...</span>
                </div>
            </div>
            <p class="form-status" aria-live="polite"></p>
            <button type="button" class="save-btn" id="save-tdee-btn" disabled>Save TDEE</button>
        </section>
    </div>
    </main>
<script>
    const chatWindow = document.querySelector('.chat-window');
    const chatInput = document.querySelector('.chat-input');
    const sendBtn = document.querySelector('.send-btn');
    const saveBtn = document.getElementById('save-tdee-btn');
    const statusText = document.querySelector('.form-status');

    const summaryFields = {
        gender: document.getElementById('summary-gender'),
        age: document.getElementById('summary-age'),
        height_cm: document.getElementById('summary-height'),
        weight_kg: document.getElementById('summary-weight'),
        activity_level: document.getElementById('summary-activity'),
        goal_type: document.getElementById('summary-goal-type'),
        goal_offset: document.getElementById('summary-goal-offset'),
        tdee_value: document.getElementById('summary-tdee'),
        goal_calories: document.getElementById('summary-goal-calories')
    };

    const storedUser = localStorage.getItem('athleticore_user');
    const currentUser = storedUser ? JSON.parse(storedUser) : null;
    if (!currentUser) {
        window.location.href = '/login';
    }

    const chatHistory = [];
    let latestExtracted = {};
    let latestTdeeResult = null;

    function setStatus(message = '', color = '#fff') {
        if (!statusText) return;
        statusText.textContent = message;
        statusText.style.color = color;
    }

    function renderSummary() {
        summaryFields.gender.textContent = latestExtracted.gender ?? '--';
        summaryFields.age.textContent = latestExtracted.age ?? '--';
        summaryFields.height_cm.textContent = latestExtracted.height_cm ?? '--';
        summaryFields.weight_kg.textContent = latestExtracted.weight_kg ?? '--';
        summaryFields.activity_level.textContent = latestExtracted.activity_level ?? '--';
        summaryFields.goal_type.textContent = latestExtracted.goal_type ?? '--';
        summaryFields.goal_offset.textContent = latestExtracted.goal_offset ?? '--';
        summaryFields.tdee_value.textContent = latestTdeeResult?.tdee_value
            ? `${Math.round(latestTdeeResult.tdee_value)} kcal`
            : 'Waiting for AI...';
        summaryFields.goal_calories.textContent = latestTdeeResult?.goal_calories
            ? `${Math.round(latestTdeeResult.goal_calories)} kcal`
            : 'Waiting for AI...';
    }

    function hasRequiredData() {
        const requiredKeys = ['age', 'gender', 'height_cm', 'weight_kg', 'activity_level', 'goal_type'];
        return requiredKeys.every(key => latestExtracted[key] !== undefined && latestExtracted[key] !== null);
    }

    function refreshSaveState() {
        const canSave = hasRequiredData() && latestTdeeResult?.ready_to_save;
        saveBtn.disabled = !canSave;
        if (canSave) {
            setStatus('Ready to save this TDEE plan.', '#4ade80');
        } else if (!latestTdeeResult?.ready_to_save) {
            setStatus('Keep chatting so we can finish your plan.', '#fbbf24');
        }
    }

    function updateExtracted(extracted) {
        if (!extracted) return;
        latestExtracted = { ...latestExtracted, ...extracted };
        renderSummary();
        refreshSaveState();
    }

    function calculateTDEE(inputs) {
        const age = Number(inputs.age);
        const height = Number(inputs.height_cm);
        const weight = Number(inputs.weight_kg);
        const activity = Number(inputs.activity_level);
        if (!Number.isFinite(age) || !Number.isFinite(height) || !Number.isFinite(weight) || !Number.isFinite(activity)) {
            return null;
        }
        const gender = (inputs.gender || '').toLowerCase();
        let bmr;
        if (gender === 'male') {
            bmr = 10 * weight + 6.25 * height - 5 * age + 5;
        } else {
            bmr = 10 * weight + 6.25 * height - 5 * age - 161;
        }
        const tdee = bmr * activity;
        let offset = Number(inputs.goal_offset);
        if (!Number.isFinite(offset) || offset === 0) {
            offset = inputs.goal_type === 'bulk' ? 300 : inputs.goal_type === 'cut' ? -500 : 0;
        }
        const goalCalories = tdee + offset;
        return {
            tdee_value: tdee,
            goal_type: inputs.goal_type,
            goal_offset: offset,
            goal_calories: goalCalories,
            ready_to_save: true
        };
    }

    function updateTdeeResult(result) {
        if (result) {
            latestTdeeResult = { ...latestTdeeResult, ...result };
        } else if (hasRequiredData()) {
            const calculated = calculateTDEE({ ...latestExtracted, ...latestTdeeResult });
            if (calculated) {
                latestTdeeResult = calculated;
            }
        }
        renderSummary();
        refreshSaveState();
    }

    function appendMessage(text, role = 'bot') {
        const messageEl = document.createElement('div');
        messageEl.classList.add('message', role === 'user' ? 'user-msg' : 'bot-msg');
        messageEl.textContent = text;
        chatWindow.appendChild(messageEl);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        appendMessage(message, 'user');
        chatInput.value = '';
        sendBtn.disabled = true;

        chatHistory.push({ role: 'user', content: message });

        try {
            const response = await fetch('/api/tdee/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message,
                    username: currentUser?.username,
                    history: chatHistory
                })
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const data = await response.json();
            const replyText = data.reply || 'Sorry, I did not understand that.';
            appendMessage(replyText);
            chatHistory.push({ role: 'assistant', content: replyText });
            updateExtracted(data.extracted_inputs);
            updateTdeeResult(data.tdee_result);
        } catch (error) {
            appendMessage('There was an error reaching the TDEE coach. Please try again.');
            console.error(error);
        } finally {
            sendBtn.disabled = false;
            chatInput.focus();
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
        }
    });

    saveBtn.addEventListener('click', async () => {
        if (saveBtn.disabled) return;
        if (!currentUser?.id) {
            setStatus('Please log in again.', '#ff6b6b');
            return;
        }

        const required = ['age', 'gender', 'height_cm', 'weight_kg', 'activity_level', 'goal_type'];
        const missing = required.filter(key => latestExtracted[key] === undefined || latestExtracted[key] === null);
        if (missing.length) {
            setStatus(`Missing data: ${missing.join(', ')}`, '#ff6b6b');
            return;
        }

        if (!latestTdeeResult?.ready_to_save) {
            setStatus('Still waiting for a full plan from the coach.', '#fbbf24');
            return;
        }

        const payload = {
            user_id: currentUser.id,
            age: Number(latestExtracted.age),
            gender: latestExtracted.gender,
            height_cm: Number(latestExtracted.height_cm),
            weight_kg: Number(latestExtracted.weight_kg),
            activity_level: latestExtracted.activity_level,
            tdee_value: latestTdeeResult.tdee_value,
            goal_type: latestTdeeResult.goal_type || latestExtracted.goal_type,
            goal_offset: latestTdeeResult.goal_offset,
            goal_calories: latestTdeeResult.goal_calories
        };

        try {
            const response = await fetch('/api/tdee/profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to save TDEE profile');
            }

            setStatus('TDEE profile saved successfully!', '#4ade80');
        } catch (error) {
            console.error(error);
            setStatus(error.message, '#ff6b6b');
        }
    });
</script>
</script>
</body>
</html>
