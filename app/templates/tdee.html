<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athleticore Login</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/style.css">
</head>
<body class="dashboard-body">
   <nav class="top-nav">
        <div class="logo">ATHLETICORE<span class="ai-text">.AI</span></div>
        <ul class="nav-links">
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/tdee" class="active">TDEE</a></li>
            <li><a href="#">Calories</a></li>
            <li><a href="#">Workout</a></li>
            <li><a href="#">Coach</a></li>
            <li><a href="#">Settings</a></li>
        </ul>
   </nav>
   <main class="main-content">
        <div class="chat-section">
            <h1>AI Coach</h1>
            <div class="chat-window"></div>
            <div class="chat-input-area">
                <input type="text" placeholder="Type a message..." class="chat-input" autocomplete="off">
                <button type="button" class="send-btn">SEND</button>
            </div>
        </div>

        <section class="chat-form-section">
            <h2 class="section-title">TDEE Information</h2>
            <form class="stats-grid" id="tdee-info-form">
                <div class="input-group">
                    <label>Activity Level Factor</label>
                    <input type="number" name="activity_level" id="activity-level-input" placeholder="1.2" step="0.1" min="1.0" max="2.5" required>
                </div>
                <div class="input-group">
                    <label>TDEE (kcal)</label>
                    <input type="number" name="tdee_value" id="tdee-value-input" placeholder="2000" min="0" required>
                </div>
                <div class="input-group">
                    <label>Goal Calories (kcal)</label>
                    <input type="number" name="goal_calories" id="goal-calories-input" placeholder="2500" min="0" required>
                </div>
                <div class="input-group">
                    <label>Goal</label>
                    <select name="goal_type" id="goal-type-input" required>
                        <option value="" disabled selected>Select</option>
                        <option value="cut">Cut</option>
                        <option value="bulk">Bulk</option>
                        <option value="maintain">Maintain</option>
                    </select>
                </div>
                <p class="form-status" aria-live="polite"></p>
                <button type="submit" class="save-btn" id="save-tdee-btn">Save TDEE</button>
            </form>
        </section>
    </main>
<script>
    const chatWindow = document.querySelector(".chat-window");
    const chatInput = document.querySelector(".chat-input");
    const sendBtn = document.querySelector(".send-btn");
    const saveBtn = document.getElementById("save-tdee-btn");
    const statusText = document.querySelector(".form-status");
    const tdeeInfoForm = document.getElementById("tdee-info-form");

    const storedUser = localStorage.getItem("athleticore_user");
    const currentUser = storedUser ? JSON.parse(storedUser) : null;

    const chatHistory = [];
    let latestTdeeResult = null;

    function setStatus(message = "", color = "#fff") {
        if (!statusText) return;
        statusText.textContent = message;
        statusText.style.color = color;
    }

    function appendMessage(text, role = "bot") {
        const messageEl = document.createElement("div");
        messageEl.classList.add("message", role === "user" ? "user-msg" : "bot-msg");
        messageEl.textContent = text;
        chatWindow.appendChild(messageEl);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) {
            return;
        }

        appendMessage(message, "user");
        chatInput.value = "";
        sendBtn.disabled = true;
        chatHistory.push({ role: "user", content: message });

        try {
            const response = await fetch("/api/tdee/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    message,
                    username: currentUser?.username,
                    history: chatHistory
                })
            });

            if (!response.ok) {
                throw new Error("Network response was not ok");
            }

            const data = await response.json();
            const replyText = data.reply || "Sorry, I did not understand that.";
            appendMessage(replyText);
            chatHistory.push({ role: "assistant", content: replyText });
            if (data.tdee_result) {
                latestTdeeResult = data.tdee_result;
                // Optionally populate form fields if AI provides values
                if (data.tdee_result.activity_level) {
                    document.getElementById("activity-level-input").value = data.tdee_result.activity_level;
                }
                if (data.tdee_result.tdee_value) {
                    document.getElementById("tdee-value-input").value = Math.round(data.tdee_result.tdee_value);
                }
                if (data.tdee_result.goal_calories) {
                    document.getElementById("goal-calories-input").value = Math.round(data.tdee_result.goal_calories);
                }
                if (data.tdee_result.goal_type) {
                    document.getElementById("goal-type-input").value = data.tdee_result.goal_type;
                }
            }
        } catch (error) {
            appendMessage("There was an error reaching the TDEE coach. Please try again.");
            console.error(error);
        } finally {
            sendBtn.disabled = false;
            chatInput.focus();
        }
    }

    sendBtn.addEventListener("click", sendMessage);
    chatInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    });

    tdeeInfoForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!currentUser?.id) {
            setStatus("Please log in again.", "#ff6b6b");
            return;
        }

        const formData = new FormData(tdeeInfoForm);
        const tdeeData = Object.fromEntries(formData.entries());

        const payload = {
            user_id: currentUser.id,
            activity_level: parseFloat(tdeeData.activity_level),
            tdee_value: parseFloat(tdeeData.tdee_value),
            goal_type: tdeeData.goal_type,
            goal_calories: parseFloat(tdeeData.goal_calories),
            chat_history: chatHistory
        };

        try {
            const response = await fetch("/api/tdee/profile", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "Failed to save TDEE profile");
            }

            setStatus("TDEE profile saved successfully!", "#4ade80");
        } catch (error) {
            console.error(error);
            setStatus(error.message, "#ff6b6b");
        }
    });

    async function loadSavedProfile() {
        if (!currentUser?.id) {
            return;
        }
        try {
            const response = await fetch(`/api/tdee/profile/${currentUser.id}`);
            if (!response.ok) {
                return;
            }
            const data = await response.json();
            const profile = data.profile;
            if (!profile) {
                return;
            }

            // Populate TDEE info form
            if (profile.activity_level) {
                document.getElementById("activity-level-input").value = profile.activity_level;
            }
            if (profile.tdee_value) {
                document.getElementById("tdee-value-input").value = profile.tdee_value;
            }
            if (profile.goal_calories) {
                document.getElementById("goal-calories-input").value = profile.goal_calories;
            }
            if (profile.goal_type) {
                document.getElementById("goal-type-input").value = profile.goal_type;
            }

            latestTdeeResult = {
                tdee_value: profile.tdee_value,
                goal_type: profile.goal_type,
                goal_calories: profile.goal_calories,
                activity_level: profile.activity_level,
                ready_to_save: true
            };

            setStatus("Loaded your latest TDEE plan.", "#93c5fd");
        } catch (error) {
            console.error("Failed to load saved TDEE profile", error);
        }
    }

    loadSavedProfile();
</script>
</body>
</html>



