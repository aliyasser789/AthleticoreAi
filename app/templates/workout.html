<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athleticore Workout</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="dashboard-body">
   <nav class="top-nav">
        <div class="logo">ATHLETICORE<span class="ai-text">.AI</span></div>
        
        <ul class="nav-links">
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/tdee">TDEE</a></li>
            <li><a href="/calories">Calories</a></li>
            <li><a href="/workout" class="active">Workout</a></li>
            <li><a href="#">Coach</a></li>
            <li><a href="#">Settings</a></li>
        </ul>
   </nav>
   <main class="main-content">
        <h2 class="section-title">Workout Log</h2>
        
        <div class="workout-log-container">
            <!-- Empty State (hidden by default) -->
            <div class="empty-state" id="empty-state" style="display: none;">
                <p>You don't have any logs yet.</p>
            </div>

            <!-- Feed Container -->
            <div class="workout-feed-container" id="workout-feed">
                <!-- Log cards will be dynamically added here -->
            </div>
        </div>

        <!-- Fixed Create Log Button -->
        <a href="/create-log" class="create-btn">Create Log</a>
   </main>
   
   <!-- Toast Notification Container -->
   <div class="toast-container" id="toast-container"></div>
   
   <script>
        // Toast notification function
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '✓' : '✕';
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
   </script>
   <script>

        // Get current day of week
        function getCurrentDay() {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[new Date().getDay()];
        }

        // Helper function to format date to day of week
        function formatDateToDay(dateString) {
            const date = new Date(dateString + 'T00:00:00'); // Add time to avoid timezone issues
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()];
        }

        // DOM elements
        const emptyState = document.getElementById('empty-state');
        const workoutFeed = document.getElementById('workout-feed');
        const currentDay = getCurrentDay();
        
        // Store workouts data
        let workoutsData = [];

        // Function to create a log card from workout data
        function createLogCard(workoutItem, isToday = false) {
            const card = document.createElement('div');
            card.className = 'log-card';
            
            if (isToday) {
                card.classList.add('today-highlight');
            }

            const workout = workoutItem.workout;
            const day = formatDateToDay(workout.date);
            const dayAbbr = day.substring(0, 3).toUpperCase();

            // Store full workout data as JSON in data attribute
            const workoutData = JSON.stringify(workoutItem);
            card.setAttribute('data-workout', workoutData);
            card.setAttribute('data-workout-id', workout.id);

            card.innerHTML = `
                <div class="day-badge">${dayAbbr}</div>
                <div class="log-summary">${workout.workout_name}</div>
                <button class="details-btn" onclick="openDetailsModalFromCard(this)">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <button class="delete-log-btn" onclick="deleteLog(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;

            return card;
        }

        // Function to delete a log
        async function deleteLog(btn) {
            const card = btn.closest('.log-card');
            if (!card) return;

            const workoutId = card.getAttribute('data-workout-id');
            if (!workoutId) return;

            // Get user from localStorage
            const storedUser = localStorage.getItem('athleticore_user');
            if (!storedUser) {
                showToast('Please log in first', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }

            let user;
            try {
                user = JSON.parse(storedUser);
            } catch (err) {
                console.error('Failed to parse stored user', err);
                showToast('Session expired. Please log in again.', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }

            if (!user || !user.id) {
                showToast('User information not found. Please log in again.', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }

            // Apply fade-out animation immediately
            card.style.opacity = '0';
            card.style.transform = 'translateX(100px)';
            card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';

            // Call API to delete
            try {
                const response = await fetch(`/api/workouts/${workoutId}?user_id=${user.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete workout');
                }

                // Show success message
                showToast('Workout deleted successfully!', 'success');
                
                // Remove from DOM after animation
                setTimeout(() => {
                    card.remove();
                    
                    // Refresh the entire page to reload workouts
                    setTimeout(() => {
                        window.location.reload();
                    }, 800);
                }, 300);
            } catch (error) {
                console.error('Error deleting workout:', error);
                showToast('Error: ' + error.message, 'error');
                // Revert animation on error
                card.style.opacity = '1';
                card.style.transform = 'translateX(0)';
            }
        }

        // Function to render logs
        function renderLogs() {
            // Clear existing content
            workoutFeed.innerHTML = '';

            // If no logs, show empty state
            if (workoutsData.length === 0) {
                emptyState.style.display = 'block';
                workoutFeed.style.display = 'none';
                return;
            }

            // Hide empty state
            emptyState.style.display = 'none';
            workoutFeed.style.display = 'block';

            // Sort workouts: today's workout first, then by date (newest first)
            const sortedWorkouts = [...workoutsData].sort((a, b) => {
                const aDay = formatDateToDay(a.workout.date);
                const bDay = formatDateToDay(b.workout.date);
                
                if (aDay === currentDay) return -1;
                if (bDay === currentDay) return 1;
                
                // Otherwise sort by date (newest first)
                return new Date(b.workout.date) - new Date(a.workout.date);
            });

            // Render each workout
            sortedWorkouts.forEach(workoutItem => {
                const workoutDay = formatDateToDay(workoutItem.workout.date);
                const isToday = workoutDay === currentDay;
                const card = createLogCard(workoutItem, isToday);
                workoutFeed.appendChild(card);
            });
        }

        // Function to open details modal from card button
        function openDetailsModalFromCard(btn) {
            const card = btn.closest('.log-card');
            if (!card) return;

            const workoutDataStr = card.getAttribute('data-workout');
            if (!workoutDataStr) return;

            try {
                const workoutItem = JSON.parse(workoutDataStr);
                openDetailsModal(workoutItem);
            } catch (e) {
                console.error('Failed to parse workout data:', e);
            }
        }

        // Function to open details modal
        function openDetailsModal(workoutItem) {
            const modal = document.getElementById('details-modal');
            if (!modal) return;

            const workout = workoutItem.workout;
            const exercises = workoutItem.exercises || [];
            
            // Format date to day of week
            const day = formatDateToDay(workout.date);
            
            // Get summary of exercises (first exercise name or count)
            const summary = exercises.length > 0 
                ? exercises[0].exercise_name 
                : workout.workout_name;
            
            // Calculate totals from exercises
            let totalWeight = 0;
            let totalSets = 0;
            let totalReps = 0;
            let maxWeight = 0;
            let maxPrevWeight = 0;
            
            exercises.forEach(ex => {
                if (ex.weight_kg) {
                    totalWeight += ex.weight_kg * (ex.sets || 0);
                    maxWeight = Math.max(maxWeight, ex.weight_kg);
                }
                if (ex.previous_weight) {
                    maxPrevWeight = Math.max(maxPrevWeight, ex.previous_weight);
                }
                totalSets += ex.sets || 0;
                totalReps += (ex.reps || 0) * (ex.sets || 0);
            });

            // Populate modal with workout data
            document.getElementById('modal-day').textContent = day || 'N/A';
            document.getElementById('modal-summary').textContent = workout.workout_name || 'N/A';
            document.getElementById('modal-weight').textContent = maxWeight > 0 ? `${maxWeight} kg` : 'N/A';
            document.getElementById('modal-prev-weight').textContent = maxPrevWeight > 0 ? `${maxPrevWeight} kg` : 'N/A';
            document.getElementById('modal-sets').textContent = totalSets > 0 ? totalSets : 'N/A';
            document.getElementById('modal-reps').textContent = totalReps > 0 ? totalReps : 'N/A';
            
            // Build notes from workout notes and exercise details
            let notesText = workout.notes || '';
            if (exercises.length > 0) {
                const exerciseDetails = exercises.map(ex => {
                    let detail = `${ex.exercise_name}: `;
                    if (ex.sets && ex.reps) detail += `${ex.sets}x${ex.reps}`;
                    if (ex.weight_kg) detail += ` @ ${ex.weight_kg}kg`;
                    if (ex.notes) detail += ` (${ex.notes})`;
                    return detail;
                }).join('\n');
                
                if (notesText) notesText += '\n\n';
                notesText += exerciseDetails;
            }
            
            document.getElementById('modal-notes').textContent = notesText || 'No notes available.';

            // Show modal
            modal.style.display = 'flex';
        }

        // Function to close details modal
        function closeDetailsModal() {
            const modal = document.getElementById('details-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Close modal when clicking outside (on overlay)
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('details-modal');
            const overlay = modal ? modal.querySelector('.modal-overlay') : null;
            if (overlay) {
                overlay.addEventListener('click', () => {
                    closeDetailsModal();
                });
            }
        });

        // Function to load workouts from API
        async function loadWorkouts() {
            // Get user from localStorage
            const storedUser = localStorage.getItem('athleticore_user');
            if (!storedUser) {
                console.log('No user found, showing empty state');
                emptyState.style.display = 'block';
                workoutFeed.style.display = 'none';
                return;
            }

            let user;
            try {
                user = JSON.parse(storedUser);
            } catch (err) {
                console.error('Failed to parse stored user', err);
                emptyState.style.display = 'block';
                workoutFeed.style.display = 'none';
                return;
            }

            if (!user || !user.id) {
                console.log('No user ID found');
                emptyState.style.display = 'block';
                workoutFeed.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/api/workouts?user_id=${user.id}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load workouts');
                }

                workoutsData = data.workouts || [];
                renderLogs();
            } catch (error) {
                console.error('Error loading workouts:', error);
                emptyState.style.display = 'block';
                workoutFeed.style.display = 'none';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadWorkouts();
        });
   </script>

   <!-- Details Modal -->
   <div id="details-modal" class="details-modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Workout Details</h2>
                <button class="modal-close-btn" onclick="closeDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-info-grid">
                    <div class="modal-info-item">
                        <div class="modal-label">Day</div>
                        <div class="modal-value" id="modal-day">-</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-label">Workout</div>
                        <div class="modal-value" id="modal-summary">-</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-label">Weight (kg)</div>
                        <div class="modal-value" id="modal-weight">-</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-label">Previous Weight (kg)</div>
                        <div class="modal-value" id="modal-prev-weight">-</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-label">Sets</div>
                        <div class="modal-value" id="modal-sets">-</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-label">Reps</div>
                        <div class="modal-value" id="modal-reps">-</div>
                    </div>
                </div>
                <div class="modal-notes-section">
                    <div class="modal-label">Notes</div>
                    <div class="modal-notes-text" id="modal-notes">-</div>
                </div>
            </div>
        </div>
   </div>
</body>
</html>
