<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athleticore Workout</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../static/css/style.css">
</head>
<body class="dashboard-body">
   <nav class="top-nav">
        <div class="logo">ATHLETICORE<span class="ai-text">.AI</span></div>
        
        <ul class="nav-links">
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/tdee">TDEE</a></li>
            <li><a href="/calories">Calories</a></li>
            <li><a href="/workout" class="active">Workout</a></li>
            <li><a href="#">Coach</a></li>
            <li><a href="#">Settings</a></li>
        </ul>
   </nav>
   <main class="main-content">
        <h2 class="section-title">Workout Log</h2>
        
        <div class="workout-log-container">
            <!-- Empty State (hidden by default) -->
            <div class="empty-state" id="empty-state" style="display: none;">
                <p>You don't have any logs yet.</p>
            </div>

            <!-- Feed Container -->
            <div class="workout-feed-container" id="workout-feed">
                <!-- Log cards will be dynamically added here -->
            </div>
        </div>

        <!-- Fixed Create Log Button -->
        <a href="/create-log" class="create-btn">Create Log</a>
   </main>
   
   <!-- Toast Notification Container -->
   <div class="toast-container" id="toast-container"></div>
   
   <script>
        // Toast notification function
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '✓' : '✕';
            toast.innerHTML = `
                <span class="toast-icon">${icon}</span>
                <span class="toast-message">${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
   </script>
   <script>

        // Get current day of week
        function getCurrentDay() {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[new Date().getDay()];
        }

        // Helper function to format date to day of week
        function formatDateToDay(dateString) {
            const date = new Date(dateString + 'T00:00:00'); // Add time to avoid timezone issues
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()];
        }

        // DOM elements
        const emptyState = document.getElementById('empty-state');
        const workoutFeed = document.getElementById('workout-feed');
        const currentDay = getCurrentDay();
        
        // Store workouts data
        let workoutsData = [];

        // Function to create a log card from workout data
        function createLogCard(workoutItem, isToday = false) {
            const card = document.createElement('div');
            card.className = 'log-card';
            
            if (isToday) {
                card.classList.add('today-highlight');
            }

            const workout = workoutItem.workout;
            const day = formatDateToDay(workout.date);
            const dayAbbr = day.substring(0, 3).toUpperCase();

            // Store full workout data as JSON in data attribute
            const workoutData = JSON.stringify(workoutItem);
            card.setAttribute('data-workout', workoutData);
            card.setAttribute('data-workout-id', workout.id);

            card.innerHTML = `
                <div class="day-badge">${dayAbbr}</div>
                <div class="log-summary">${workout.workout_name}</div>
                <button class="delete-log-btn" onclick="deleteLog(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;

            // Make card clickable (except delete button)
            card.style.cursor = 'pointer';
            card.addEventListener('click', (event) => {
                if (event.target.closest('.delete-log-btn')) return;
                const workoutDataStr = card.getAttribute('data-workout');
                if (workoutDataStr) {
                    try {
                        const workoutData = JSON.parse(workoutDataStr);
                        openDetailsModal(workoutData);
                    } catch (e) {
                        console.error('Failed to parse workout data:', e);
                    }
                }
            });

            return card;
        }

        // Function to delete a log
        async function deleteLog(btn) {
            const card = btn.closest('.log-card');
            if (!card) return;

            const workoutId = card.getAttribute('data-workout-id');
            if (!workoutId) return;

            // Get user from localStorage
            const storedUser = localStorage.getItem('athleticore_user');
            if (!storedUser) {
                showToast('Please log in first', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }

            let user;
            try {
                user = JSON.parse(storedUser);
            } catch (err) {
                console.error('Failed to parse stored user', err);
                showToast('Session expired. Please log in again.', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }

            if (!user || !user.id) {
                showToast('User information not found. Please log in again.', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }

            // Apply fade-out animation immediately
            card.style.opacity = '0';
            card.style.transform = 'translateX(100px)';
            card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';

            // Call API to delete
            try {
                const response = await fetch(`/api/workouts/${workoutId}?user_id=${user.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete workout');
                }

                // Show success message
                showToast('Workout deleted successfully!', 'success');
                
                // Remove from DOM after animation
                setTimeout(() => {
                    card.remove();
                    
                    // Refresh the entire page to reload workouts
                    setTimeout(() => {
                        window.location.reload();
                    }, 800);
                }, 300);
            } catch (error) {
                console.error('Error deleting workout:', error);
                showToast('Error: ' + error.message, 'error');
                // Revert animation on error
                card.style.opacity = '1';
                card.style.transform = 'translateX(0)';
            }
        }

        // Function to render logs
        function renderLogs() {
            // Clear existing content
            workoutFeed.innerHTML = '';

            // If no logs, show empty state
            if (workoutsData.length === 0) {
                emptyState.style.display = 'block';
                workoutFeed.style.display = 'none';
                return;
            }

            // Hide empty state
            emptyState.style.display = 'none';
            workoutFeed.style.display = 'block';

            // Sort workouts: today's workout first, then by date (newest first)
            const sortedWorkouts = [...workoutsData].sort((a, b) => {
                const aDay = formatDateToDay(a.workout.date);
                const bDay = formatDateToDay(b.workout.date);
                
                if (aDay === currentDay) return -1;
                if (bDay === currentDay) return 1;
                
                // Otherwise sort by date (newest first)
                return new Date(b.workout.date) - new Date(a.workout.date);
            });

            // Render each workout
            sortedWorkouts.forEach(workoutItem => {
                const workoutDay = formatDateToDay(workoutItem.workout.date);
                const isToday = workoutDay === currentDay;
                const card = createLogCard(workoutItem, isToday);
                workoutFeed.appendChild(card);
            });
        }

        // Function to open details modal
        function openDetailsModal(workoutItem) {
            const modal = document.getElementById('details-modal');
            if (!modal) return;

            const workout = workoutItem.workout;
            const exercises = workoutItem.exercises || [];
            
            // Store workout ID in modal dataset
            modal.dataset.workoutId = workout.id;
            
            // Format date to day of week
            const day = formatDateToDay(workout.date);
            
            // Populate workout-level fields
            const workoutNameInput = document.getElementById('modal-workout-name');
            const workoutDayEl = document.getElementById('modal-day');
            const workoutNotesTextarea = document.getElementById('modal-workout-notes');
            
            if (workoutNameInput) workoutNameInput.value = workout.workout_name || '';
            if (workoutDayEl) workoutDayEl.textContent = day || 'N/A';
            if (workoutNotesTextarea) workoutNotesTextarea.value = workout.notes || '';
            
            // Clear and populate exercises
            const exercisesContainer = document.getElementById('modal-exercises-list');
            if (exercisesContainer) {
                exercisesContainer.innerHTML = '';
                
                exercises.forEach((exercise, index) => {
                    const exerciseBlock = createExerciseBlock(exercise, index);
                    exercisesContainer.appendChild(exerciseBlock);
                });
            }

            // Show modal
            modal.style.display = 'flex';
        }

        // Function to create an editable exercise block
        function createExerciseBlock(exercise, index) {
            const block = document.createElement('div');
            block.className = 'exercise-modal-block';
            block.setAttribute('data-exercise-index', index);
            if (exercise.id) {
                block.setAttribute('data-exercise-id', exercise.id);
            }
            
            block.innerHTML = `
                <div class="exercise-header-editable">
                    <input type="text" class="exercise-name-input" data-field="exercise-name" value="${exercise.exercise_name || ''}" placeholder="Exercise Name">
                    <i class="fas fa-pen edit-icon"></i>
                </div>
                
                <div class="exercise-stats-row">
                    <div class="stat-group">
                        <label class="stat-label">Reps</label>
                        <div class="old-new-inputs">
                            <input type="number" class="stat-input old-value" data-field="reps-old" value="" placeholder="Old" min="0">
                            <input type="number" class="stat-input new-value" data-field="reps-new" value="${exercise.reps || ''}" placeholder="New" min="0">
                        </div>
                    </div>
                    
                    <div class="stat-group">
                        <label class="stat-label">Sets</label>
                        <div class="old-new-inputs">
                            <input type="number" class="stat-input old-value" data-field="sets-old" value="" placeholder="Old" min="0">
                            <input type="number" class="stat-input new-value" data-field="sets-new" value="${exercise.sets || ''}" placeholder="New" min="0">
                        </div>
                    </div>
                </div>
                
                <div class="exercise-weight-row">
                    <div class="weight-group">
                        <label class="weight-label">Weight (KG)</label>
                        <div class="weight-input-wrapper">
                            <input type="number" class="weight-input" data-field="weight" value="${exercise.weight_kg || ''}" placeholder="0" min="0" step="0.5">
                            <i class="fas fa-pen edit-icon"></i>
                        </div>
                    </div>
                    
                    <div class="weight-group">
                        <label class="weight-label">Previous Weight (KG)</label>
                        <div class="weight-input-wrapper">
                            <input type="number" class="weight-input" data-field="prev-weight" value="${exercise.previous_weight || ''}" placeholder="0" min="0" step="0.5">
                            <i class="fas fa-pen edit-icon"></i>
                        </div>
                    </div>
                </div>
                
                <div class="exercise-notes-group">
                    <label class="exercise-notes-label">Notes</label>
                    <textarea class="exercise-notes-textarea" data-field="exercise-notes" placeholder="Add notes about this exercise...">${exercise.notes || ''}</textarea>
                </div>
            `;
            
            return block;
        }

        // Function to close details modal
        function closeDetailsModal() {
            const modal = document.getElementById('details-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Close modal when clicking outside (on overlay)
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('details-modal');
            const overlay = modal ? modal.querySelector('.modal-overlay') : null;
            if (overlay) {
                overlay.addEventListener('click', () => {
                    closeDetailsModal();
                });
            }
        });

        // Function to load workouts from API
        async function loadWorkouts() {
            // Get user from localStorage
            const storedUser = localStorage.getItem('athleticore_user');
            if (!storedUser) {
                console.log('No user found, showing empty state');
                emptyState.style.display = 'block';
                workoutFeed.style.display = 'none';
                return;
            }

            let user;
            try {
                user = JSON.parse(storedUser);
            } catch (err) {
                console.error('Failed to parse stored user', err);
                emptyState.style.display = 'block';
                workoutFeed.style.display = 'none';
                return;
            }

            if (!user || !user.id) {
                console.log('No user ID found');
                emptyState.style.display = 'block';
                workoutFeed.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/api/workouts?user_id=${user.id}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load workouts');
                }

                workoutsData = data.workouts || [];
                renderLogs();
            } catch (error) {
                console.error('Error loading workouts:', error);
                emptyState.style.display = 'block';
                workoutFeed.style.display = 'none';
            }
        }

        // Function to save workout changes
        async function saveWorkoutChanges() {
            const modal = document.getElementById('details-modal');
            if (!modal) return;
            
            const workoutId = modal.dataset.workoutId;
            if (!workoutId) {
                showToast('Workout ID not found', 'error');
                return;
            }

            // Get user from localStorage
            const storedUser = localStorage.getItem('athleticore_user');
            if (!storedUser) {
                showToast('Please log in first', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }

            let user;
            try {
                user = JSON.parse(storedUser);
            } catch (err) {
                console.error('Failed to parse stored user', err);
                showToast('Session expired. Please log in again.', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }

            if (!user || !user.id) {
                showToast('User information not found. Please log in again.', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return;
            }

            // Collect workout-level fields
            const workoutNameInput = document.getElementById('modal-workout-name');
            const workoutNotesTextarea = document.getElementById('modal-workout-notes');

            const workout_name = workoutNameInput ? workoutNameInput.value.trim() : '';
            const notes = workoutNotesTextarea ? workoutNotesTextarea.value.trim() : '';

            if (!workout_name) {
                showToast('Workout name is required', 'error');
                return;
            }

            // Collect exercises
            const exerciseBlocks = document.querySelectorAll('#modal-exercises-list .exercise-modal-block');
            const exercises = [];

            exerciseBlocks.forEach((block, index) => {
                const exerciseId = block.dataset.exerciseId || null;

                const nameInput = block.querySelector('[data-field="exercise-name"]');
                const repsNewInput = block.querySelector('[data-field="reps-new"]');
                const setsNewInput = block.querySelector('[data-field="sets-new"]');
                const weightInput = block.querySelector('[data-field="weight"]');
                const prevWeightInput = block.querySelector('[data-field="prev-weight"]');
                const notesInput = block.querySelector('[data-field="exercise-notes"]');

                const exercise_name = nameInput ? nameInput.value.trim() : '';
                if (!exercise_name) {
                    return; // Skip exercises without names
                }

                exercises.push({
                    id: exerciseId ? parseInt(exerciseId) : null,
                    exercise_name: exercise_name,
                    reps: repsNewInput ? parseInt(repsNewInput.value || 0) : 0,
                    sets: setsNewInput ? parseInt(setsNewInput.value || 0) : 0,
                    weight_kg: weightInput ? parseFloat(weightInput.value || 0) : 0,
                    previous_weight: prevWeightInput ? parseFloat(prevWeightInput.value || 0) : 0,
                    notes: notesInput ? notesInput.value.trim() : '',
                    order_index: index
                });
            });

            if (exercises.length === 0) {
                showToast('At least one exercise is required', 'error');
                return;
            }

            const payload = {
                user_id: user.id,
                workout_name: workout_name,
                notes: notes,
                exercises: exercises
            };

            try {
                const response = await fetch(`/api/workouts/${workoutId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to save workout');
                }

                showToast('Workout updated successfully!', 'success');
                closeDetailsModal();

                // Refresh workouts list
                setTimeout(() => {
                    window.location.reload();
                }, 800);
            } catch (error) {
                console.error('Error saving workout:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadWorkouts();

            // Wire up Save button
            const saveBtn = document.getElementById('modal-save-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveWorkoutChanges);
            }
        });
   </script>

   <!-- Details Modal -->
   <div id="details-modal" class="details-modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-left">
                    <div class="title-edit-group">
                        <input type="text" id="modal-workout-name" class="modal-workout-name-input" placeholder="Workout Name">
                        <i class="fas fa-pen title-edit-icon"></i>
                    </div>
                </div>
                <div class="modal-header-right">
                    <span class="modal-day-badge" id="modal-day">-</span>
                    <button class="modal-close-btn" onclick="closeDetailsModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="modal-workout-notes-section">
                    <div class="modal-notes-header">
                        <label class="modal-notes-label">Notes</label>
                        <i class="fas fa-pen edit-icon"></i>
                    </div>
                    <textarea id="modal-workout-notes" class="modal-workout-notes-textarea" placeholder="Add workout notes..."></textarea>
                </div>
                
                <div class="modal-exercises-section">
                    <h3 class="modal-exercises-title">Exercises</h3>
                    <div id="modal-exercises-list" class="modal-exercises-list">
                        <!-- Exercise blocks will be dynamically added here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-save-btn" id="modal-save-btn">Save Changes</button>
            </div>
        </div>
   </div>
</body>
</html>
